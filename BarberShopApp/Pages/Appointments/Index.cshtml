@page
@model BarberShopApp.Pages.Appointments.IndexModel

@{
    ViewData["Title"] = "Agenda de Citas";
}

<div class="container my-4">

    <div class="d-flex justify-content-between align-items-center mb-5 pb-3 border-bottom">
        <h1 class="display-6 fw-bold text-dark mb-0">
            <i class="bi bi-calendar-day me-3 text-brand-primary"></i> @ViewData["Title"]
        </h1>
        <a asp-page="Create" class="btn btn-dark btn-lg shadow">
            <i class="bi bi-plus-circle-fill me-2"></i> Crear Nueva Cita
        </a>
    </div>

    <h2 class="h4 mb-3 text-muted">Visualización Mensual/Semanal</h2>
    <div id='calendar' class="mb-5 p-3 border rounded-4 shadow-sm bg-white"></div>

    <h2 class="h4 mt-5 mb-3 text-dark">
        <i class="bi bi-list-columns-reverse me-2"></i> Listado de Citas (Diagnóstico)
    </h2>
    <p class="text-muted small">
        Esta tabla permite verificar la carga de datos si el calendario tiene problemas.
        Si la lista está vacía, el problema es de la base de datos o filtro Tenant.
    </p>
    
    @if (Model.Appointment.Any())
    {
        <div class="table-responsive p-3 bg-white rounded-4 shadow-sm border">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-dark">
                    <tr>
                        <th style="width: 20%;">Fecha y Hora</th>
                        <th style="width: 20%;">Cliente</th>
                        <th style="width: 20%;">Servicio</th>
                        <th style="width: 15%;">Barbero</th>
                        <th style="width: 15%;">Estado</th>
                        <th style="width: 10%;">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.Appointment)
                    {
                        <tr>
                            <td>
                                <span class="fw-bold">@item.DateTime.ToString("dd MMM yyyy")</span><br />
                                <span class="badge bg-dark">@item.DateTime.ToString("HH:mm")</span>
                            </td>
                            <td>
                                <span class="text-dark fw-semibold">@Html.DisplayFor(modelItem => item.ClientName)</span><br />
                                <small class="text-info">@Html.DisplayFor(modelItem => item.ClientEmail)</small>
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.Service!.Name)
                                <span class="badge bg-secondary ms-2">@item.Service!.DurationMinutes min</span>
                            </td>
                            <td>
                                <span class="text-muted">@Html.DisplayFor(modelItem => item.Barber!.Name)</span>
                            </td>
                            <td>
                                @{
                                    string badgeClass = item.Status switch
                                    {
                                        "Confirmada" => "bg-success",
                                        "Pendiente" => "bg-warning text-dark",
                                        "Cancelada" => "bg-danger",
                                        _ => "bg-secondary"
                                    };
                                }
                                <span class="badge @badgeClass p-2">@Html.DisplayFor(modelItem => item.Status)</span>
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <a asp-page="./Edit" asp-route-id="@item.AppointmentId" class="btn btn-sm btn-outline-dark" title="Editar"><i class="bi bi-pencil"></i></a>
                                    <a asp-page="./Details" asp-route-id="@item.AppointmentId" class="btn btn-sm btn-outline-dark" title="Detalles"><i class="bi bi-info-circle"></i></a>
                                    <a asp-page="./Delete" asp-route-id="@item.AppointmentId" class="btn btn-sm btn-outline-danger" title="Eliminar"><i class="bi bi-trash"></i></a>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
    else
    {
        <div class="alert alert-info text-center rounded-3 p-3 shadow-sm">
            <i class="bi bi-info-circle me-2"></i> No hay citas registradas para este Tenant.
        </div>
    }
</div>

@section Scripts {

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');

            // Generamos la URL del handler. Debe ser similar a /Appointments?handler=CalendarData
            var eventsUrl = '@Url.Page("Index", "CalendarData")';
            console.log('DEBUG: URL de la fuente de eventos de FullCalendar:', eventsUrl); // <--- DIAGNÓSTICO CLAVE

            // 1. Inicialización de FullCalendar
            var calendar = new FullCalendar.Calendar(calendarEl, {

                // Configuración General
                initialView: 'dayGridMonth',
                locale: 'es',
                slotDuration: '00:30:00',
                slotMinTime: '09:00:00',
                slotMaxTime: '18:00:00',
                height: 'auto',

                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },

                // 2. Fuente de Datos
                events: eventsUrl,

                // Configuración de Citas (Eventos)
                eventDidMount: function(info) {
                    var durationMinutes = (info.event.end.getTime() - info.event.start.getTime()) / 60000;
                    info.el.title = info.event.title + " | Duración: " + durationMinutes + " min";
                },

                // 3. Manejo de Clic en una Cita (para ver detalles)
                eventClick: function(info) {
                    // Usamos el ID de la cita para redirigir a la página de Detalles
                    window.location.href = '/Appointments/Details?id=' + info.event.id;
                }
            });

            calendar.render();
        });
    </script>
}